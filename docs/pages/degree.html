<!DOCTYPE html>
<html>
<head>
<title>Ensenyaments</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- External CSS Libraries -->
<link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
  /* Base typography styles */
  html, body, h1, h2, h3, h4, h5 {
      font-family: "Raleway", sans-serif;
  }

/* Responsive page styles */
.w3-quarter {
  width: 25%;
}

@media screen and (max-width: 600px) {
  .w3-main {
    margin-left: 0;
  }
}

@media screen and (max-width: 600px) {
  .w3-quarter {
    width: 100%;
  }
}

.w3-sidebar {
  width: 300px;
  max-width: 80vw; /* Adjusts for small screens */
}

.w3-row {
  display: flex;
  flex-wrap: wrap;
}

/* Copyright styles */
.copyright {
  font-size: 14px;
  color: #555;
  padding: 8px 0;
}

.copyright a {
  color: #0066cc;
  text-decoration: none;
}

.copyright a:hover {
  text-decoration: underline;
}

.copyright span {
  margin: 0 5px;
  color: #999;
}

/* Small screen adjustments */
@media screen and (max-width: 600px) {
  .copyright {
    font-size: 12px;
    line-height: 1.5;
  }

  .copyright span {
    display: inline-block;
    margin: 0 3px;
  }
}

/* Graphic styles */
.charts-wrapper {
  width: 100%;
  overflow: hidden;
}

.chart-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 20px;
  padding: 20px;
}

.chart-container {
  background: #f5f5f5;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  text-align: center;
}

.chart-container h3 {
  margin-top: 0;
  font-size: 1.2em;
}

.chart-container p {
  margin-bottom: 15px;
  color: #666;
}

.chart-wrapper {
  position: relative;
  margin: 0 auto;
  width: 100%;
  max-width: 300px;
}

.chart-wrapper canvas {
  width: 100% !important;
  height: auto !important;
  max-height: 300px;
}

/* Interactive chart styles */
.interactive-chart-container {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}

.interactive-chart-wrapper {
  height: 500px;
  margin-top: 20px;
}

/* ODS legend styles */
.sdg-legend {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
  justify-content: center;
}

.sdg-legend-item {
  display: flex;
  align-items: center;
  margin-right: 10px;
  margin-bottom: 5px;
  font-size: 0.8em;
}

.sdg-color {
  width: 15px;
  height: 15px;
  margin-right: 5px;
  border-radius: 3px;
}

.sdg-code {
  font-weight: bold;
  margin-right: 5px;
}

/* Selector styles */
.selector-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 20px;
}

.selector-box {
  flex: 1;
  min-width: 250px;
}

.selector-box label {
  display: block;
  margin-bottom: 8px;
  font-weight: bold;
}

/* Degree info styles */
.degree-info {
  background-color: #f9f9f9;
  padding: 15px;
  border-radius: 5px;
  margin-bottom: 20px;
}

.degree-info p {
  margin: 5px 0;
}

.degree-info strong {
  color: #333;
}

/* Fropdown styles */
.w3-dropdown-content {
  display: none;
  position: relative;
  background-color: #f9f9f9;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

.w3-dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
}

.w3-dropdown-content a:hover {background-color: #f1f1f1}

.w3-dropdown-clicker:hover .w3-dropdown-content {display: block;}
</style>
</head>
<body class="w3-light-grey">

<!-- Top container -->
<div class="w3-bar w3-top w3-black w3-large" style="z-index:4">
  <button class="w3-bar-item w3-button w3-hide-large w3-hover-none w3-hover-text-light-grey" onclick="w3_open();"><i class="fa fa-bars"></i>  Menu</button>
  <span class="w3-bar-item w3-right">ODS a la Universitat Rovira i Virgili</span>
</div>

<!-- Sidebar Navigation -->
<nav class="w3-sidebar w3-collapse w3-white w3-animate-left" style="z-index:3;width:300px;" id="mySidebar"><br>
  <div class="w3-container w3-row">
      <div class="w3-col s4">
          <img src="../assets/logos/edited/cat/cat_ods_logo_cut.png" class="w3-circle" style="width:72px">
      </div>
      <div class="w3-col s8 w3-bar">
          <span>ODS a la</span>
          <span>Universitat Rovira i Virgili</span>
      </div>
  </div>
  <hr>
  <div class="w3-bar-block">
      <a href="../index.html" class="w3-bar-item w3-button w3-padding">
          <i class="fa fa-home fa-fw"></i> Inici
      </a>
      <div class="w3-dropdown-clicker w3-bar-item w3-button w3-padding">
          <i class="fa fa-line-chart fa-fw"></i> Anàlisi
          <div class="w3-dropdown-content">
              <a href="../pages/faculty.html" class="w3-bar-item w3-button w3-padding">
                  <i class="fa fa-university fa-fw"></i> Facultats i Escoles (núvol de paraules)
              </a>
              <a href="../pages/faculty2.html" class="w3-bar-item w3-button w3-padding">
                  <i class="fa fa-university fa-fw"></i> Facultats i Escoles (gràfics circulars)
              </a>
              <a href="../pages/degree.html" class="w3-bar-item w3-button w3-padding w3-blue">
                  <i class="fa fa-book fa-fw"></i> Ensenyaments
              </a>
              <a href="../pages/course.html" class="w3-bar-item w3-button w3-padding">
                  <i class="fa fa-pencil fa-fw"></i> Assignatures de l'ensenyament
              </a>
              <a href="../pages/course2.html" class="w3-bar-item w3-button w3-padding">
                  <i class="fa fa-pencil fa-fw"></i> Assignatura en detall
              </a>
          </div>
      </div>
      <a href="../pages/info.html" class="w3-bar-item w3-button w3-padding">
          <i class="fa fa-info-circle fa-fw"></i> Informació
      </a>
      <a href="../pages/contact.html" class="w3-bar-item w3-button w3-padding">
          <i class="fa fa-envelope fa-fw"></i> Contacte
      </a>
  </div>
</nav>

<!-- Overlay effect when opening sidebar on small screens -->
<div class="w3-overlay w3-hide-large w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>

<!-- !PAGE CONTENT! -->
<div class="w3-main" style="margin-left:300px;margin-top:43px;">

  <!-- Header -->
  <header class="w3-container" style="padding-top:22px">
    <h5><b><i class="fa fa-book"></i> Ensenyaments</b></h5>
  </header>

  <div class="w3-container">
    <h1>Ensenyaments de la Universitat Rovira i Virgili</h1>
    <p>Aquesta pàgina mostra informació sobre tots els ensenyaments de la URV i la seva alineació amb els Objectius de Desenvolupament Sostenible.</p>
  </div>

  <!-- Interactive Wordcloud -->
  <div class="w3-container">
    <div class="interactive-chart-container" style="display: flex; flex-wrap: wrap;">
      <!-- Left box -->
      <div style="flex: 1; min-width: 250px; max-width: 25%; padding-right: 20px;">
        <h2>ODS per ensenyament</h2>
        <p>Selecciona una facultat i un ensenyament per veure la distribució percentual dels ODS:</p>

        <div class="selector-container">
          <div class="selector-box">
            <label for="faculty-select">Facultat:</label>
            <select id="faculty-select" class="w3-select w3-border" onchange="updateDegreeSelect()">
              <option value="">-- Selecciona una facultat --</option>
              <!-- Options will be filled automaticaly -->
            </select>
          </div>
          <div class="selector-box">
            <label for="degree-select">Ensenyament:</label>
            <select id="degree-select" class="w3-select w3-border" onchange="updateBarChart()" disabled>
              <option value="">-- Selecciona un ensenyament --</option>
              <!-- Options will be filled automaticaly -->
            </select>
          </div>
        </div>

        <div id="degree-info-container" class="degree-info" style="display: none; margin-top: 20px;">
          <h3 id="degree-title"></h3>
          <p><strong>Facultat:</strong> <span id="degree-faculty"></span></p>
          <p><strong>Total d'assignatures:</strong> <span id="courses_per_degree"></span></p>
          <p><strong>Assignatures amb ODS:</strong> <span id="sdg_courses_degree"></span></p>
          <p><strong>Ratio d'assignatures amb ODS per ensenyament:</strong> <span id="sdg_ratio_degree"></span>%</p>
        </div>
      </div>

       <!-- Right box -->
      <div style="flex: 4; min-width: 400px; max-width: 75%;">
        <div class="interactive-chart-wrapper" style="height: 500px;">
          <canvas id="interactive-bar-chart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ODS legend -->
  <div class="w3-container">
    <div class="sdg-legend" id="sdg-legend-top"></div>
  </div>

  <!-- Footer -->
  <footer class="w3-container w3-padding-16 w3-light-grey">
    <div class="footer-content">
      <div class="copyright w3-center">
        © Universitat Rovira i Virgili
        <span>·</span>
        <a href="/ca/universitat/comunicacio/web/legal/">Avís legal</a>
        <span>·</span>
        <a href="/ca/universitat/comunicacio/web/legal/galetes/">Política de galetes</a>
        <span>·</span>
        <a href="/ca/universitat/comunicacio/web/accessibilitat/">Accessibilitat</a>
        <span>·</span>
        <a href="/ca/universitat/comunicacio/web/suport/">Sobre aquest web</a>
      </div>
    </div>
  </footer>

  <!-- End page content -->
</div>

<!-- Load the chart libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
  // Get the Sidebar
  var mySidebar = document.getElementById("mySidebar");

  // Get the DIV with overlay effect
  var overlayBg = document.getElementById("myOverlay");

  // Toggle between showing and hiding the sidebar, and add overlay effect
  function w3_open() {
    if (mySidebar.style.display === 'block') {
      mySidebar.style.display = 'none';
      overlayBg.style.display = "none";
    } else {
      mySidebar.style.display = 'block';
      overlayBg.style.display = "block";
    }
  }

  // Close the sidebar with the close button
  function w3_close() {
    mySidebar.style.display = "none";
    overlayBg.style.display = "none";
  }

  // Official SDG colors
  const sdgDefinitions = {
    "ODS-01": "Fi de la pobresa",
    "ODS-02": "Fam zero",
    "ODS-03": "Salut i benestar",
    "ODS-04": "Educació de qualitat",
    "ODS-05": "Igualtat de gènere",
    "ODS-06": "Aigua neta i sanejament",
    "ODS-07": "Energia neta i assequible",
    "ODS-08": "Treball digne i creixement econòmic",
    "ODS-09": "Indústria, innovació i infraestructura",
    "ODS-10": "Reducció de les desigualtats",
    "ODS-11": "Ciutats i comunitats sostenibles",
    "ODS-12": "Producció i consum responsables",
    "ODS-13": "Acció climàtica",
    "ODS-14": "Vida submarina",
    "ODS-15": "Vida d'ecosistemes terrestres",
    "ODS-16": "Pau, justícia i institucions sòlides",
    "ODS-17": "Aliança per assolir els objectius"
  };

  // Update colors while maintaining the same references
  const sdgColors = {
    "ODS-01": "#e5243b",
    "ODS-02": "#dda63a",
    "ODS-03": "#4c9f38",
    "ODS-04": "#c5192d",
    "ODS-05": "#ff3a21",
    "ODS-06": "#26bde2",
    "ODS-07": "#fcc30b",
    "ODS-08": "#a21942",
    "ODS-09": "#fd6925",
    "ODS-10": "#dd1367",
    "ODS-11": "#fd9d24",
    "ODS-12": "#bf8b2e",
    "ODS-13": "#3f7e44",
    "ODS-14": "#0a97d9",
    "ODS-15": "#56c02b",
    "ODS-16": "#00689d",
    "ODS-17": "#19486a"
  };

  // Function to create the SDG legend
  function createSDGLegend(containerId) {
    const legendContainer = document.getElementById(containerId);
    legendContainer.innerHTML = '';

    for (const [code, name] of Object.entries(sdgDefinitions)) {
      const legendItem = document.createElement('div');
      legendItem.className = 'sdg-legend-item';
      legendItem.innerHTML = `
        <div class="sdg-color" style="background-color: ${sdgColors[code]};"></div>
        <span class="sdg-code">${code}</span>
        <span class="sdg-name">${name}</span>
      `;
      legendContainer.appendChild(legendItem);
    }
  }

  // Global variable to store faculty data
  let facultiesData = [];

  async function loadFacultiesData() {
    try {
      const response = await fetch('../data/degree_sdg_data.json');
      if (!response.ok) throw new Error('Error al cargar los datos');
      facultiesData = await response.json();

      // Transform SDG to ODS in the data if necessary
      facultiesData.forEach(faculty => {
        faculty.degrees?.forEach(degree => {
          if (degree.percentages) {
            const newPercentages = {};
            Object.keys(degree.percentages).forEach(key => {
              newPercentages[key.replace('SDG', 'ODS')] = degree.percentages[key];
            });
            degree.percentages = newPercentages;
          }

          if (degree.sdgs) {
            const newSdgs = {};
            Object.keys(degree.sdgs).forEach(key => {
              newSdgs[key.replace('SDG', 'ODS')] = degree.sdgs[key];
            });
            degree.sdgs = newSdgs;
          }
        });
      });

      initInteractiveBarChart();
    } catch (error) {
      console.error('Error:', error);
      // Error handling...
    }
  }

  // Function to initialize the interactive bar chart
  function initInteractiveBarChart() {
    // Populate the faculty selector
    const facultySelect = document.getElementById('faculty-select');

    facultiesData.forEach(faculty => {
      const option = document.createElement('option');
      option.value = faculty.faculty;
      option.textContent = faculty.faculty;
      facultySelect.appendChild(option);
    });

    // Create the initially empty chart
    const ctx = document.getElementById('interactive-bar-chart').getContext('2d');
    window.interactiveBarChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(sdgDefinitions),
        datasets: [{
          label: "Percentatge d'ODS",
          data: Array(Object.keys(sdgDefinitions).length).fill(0),
          backgroundColor: Object.keys(sdgDefinitions).map(sdg => sdgColors[sdg]),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 20,
            title: {
              display: true,
              text: 'Percentatge (%)'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Objetius de Desenvolupament Sostenible (ODS)'
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                const code = context.label;
                const name = sdgDefinitions[code] || '';

                // Get the data of the selected degree
                const facultySelect = document.getElementById('faculty-select');
                const degreeSelect = document.getElementById('degree-select');
                const selectedFaculty = facultySelect.value;
                const selectedDegree = degreeSelect.value;

                if (!selectedFaculty || !selectedDegree) return `${code}: ${name} - ${context.parsed.y}%`;

                const faculty = facultiesData.find(f => f.faculty === selectedFaculty);
                if (!faculty || !faculty.degrees) return `${code}: ${name} - ${context.parsed.y}%`;

                const degreeData = faculty.degrees.find(d => d.degree === selectedDegree);
                if (!degreeData || !degreeData.sdgs) return `${code}: ${name} - ${context.parsed.y}%`;

                const absoluteValue = degreeData.sdgs[code] || 0;
                const percentage = context.parsed.y;

                return `${code}: ${name} - ${percentage}% (Identificat en ${absoluteValue} assignatures)`;
              }
            }
          },
          legend: {
            display: false
          }
        }
      }
    });
  }

  // Function to update the degree selector based on the selected faculty
  function updateDegreeSelect() {
    const facultySelect = document.getElementById('faculty-select');
    const degreeSelect = document.getElementById('degree-select');
    const selectedFaculty = facultySelect.value;

    degreeSelect.innerHTML = '<option value="">-- Selecciona un ensenyament --</option>';
    degreeSelect.disabled = !selectedFaculty;

    if (selectedFaculty) {
      const faculty = facultiesData.find(f => f.faculty === selectedFaculty);
      if (faculty && faculty.degrees) {
        faculty.degrees.forEach(degree => {
          const option = document.createElement('option');
          option.value = degree.degree;
          option.textContent = degree.degree;
          degreeSelect.appendChild(option);
        });
      }
    }

    // Clear the chart if no degree is selected
    updateBarChart();
  }

  // Function to update the chart based on the selected degree
  function updateBarChart() {
    const facultySelect = document.getElementById('faculty-select');
    const degreeSelect = document.getElementById('degree-select');
    const selectedFaculty = facultySelect.value;
    const selectedDegree = degreeSelect.value;
    const infoContainer = document.getElementById('degree-info-container');

    if (!selectedFaculty || !selectedDegree) {
      // If no faculty or degree is selected, clear the chart and hide info
      infoContainer.style.display = 'none';
      window.interactiveBarChart.data.datasets[0].data = Array(Object.keys(sdgDefinitions).length).fill(0);
      window.interactiveBarChart.update();
      return;
    }

    // Find the data of the selected degree
    const faculty = facultiesData.find(f => f.faculty === selectedFaculty);
    if (!faculty || !faculty.degrees) return;

    const degreeData = faculty.degrees.find(d => d.degree === selectedDegree);
    if (!degreeData) return;

    // Show degree information
    infoContainer.style.display = 'block';
    document.getElementById('degree-title').textContent = selectedDegree;
    document.getElementById('degree-faculty').textContent = selectedFaculty;
    document.getElementById('courses_per_degree').textContent = degreeData.courses_per_degree;
    document.getElementById('sdg_courses_degree').textContent = degreeData.sdg_courses_degree;
    document.getElementById('sdg_ratio_degree').textContent = degreeData.sdg_ratio_degree;

    // Prepare data for the chart
    const labels = Object.keys(sdgDefinitions);
    const data = labels.map(sdg => degreeData.percentages[sdg] || 0);

    // Update the chart
    window.interactiveBarChart.data.datasets[0].data = data;
    window.interactiveBarChart.data.datasets[0].label = `Percentatge d'ODS - ${selectedDegree}`;
    window.interactiveBarChart.update();
  }

  // Load data and create charts
  document.addEventListener('DOMContentLoaded', function() {
    // Create SDG legends
    createSDGLegend('sdg-legend-top');

    // Load faculty data
    loadFacultiesData();
  });
</script>


</body>
</html>
