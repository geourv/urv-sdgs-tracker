<!DOCTYPE html>
<html>
<head>
<title>Assignatures</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- External CSS Libraries -->
<link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
  /* Base typography styles */
  html, body, h1, h2, h3, h4, h5 {
      font-family: "Raleway", sans-serif;
  }

  .w3-main {
    margin-left: 300px;
    margin-top: 43px;
    padding-left: 40px;
    padding-right: 40px;
  }

  .w3-quarter {
    width: 25%;
  }

  .w3-sidebar {
    width: 300px;
    max-width: 80vw;
  }

  .w3-row {
    display: flex;
    flex-wrap: wrap;
  }

  /* Copyright */
  .copyright {
    font-size: 14px;
    color: #555;
    padding: 8px 0;
  }

  .copyright a {
    color: #0066cc;
    text-decoration: none;
  }

  .copyright a:hover {
    text-decoration: underline;
  }

  .copyright span {
    margin: 0 5px;
    color: #999;
  }

  /* Selectors */
  .selector-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
  }

  .selector-box {
    width: 100%;
    margin-bottom: 15px;
  }

  .selector-box label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
  }

  /* Degree Information */
  .degree-info {
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
  }

  .degree-info p {
    margin: 5px 0;
  }

  .degree-info strong {
    color: #333;
  }

  /* Courses Table */
  .courses-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .courses-table th, .courses-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }

  .courses-table th {
    background-color: #f2f2f2;
  }

  .courses-table tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  .course-row {
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .course-row:hover {
    background-color: #f1f1f1 !important;
  }

  .course-details-row {
    background-color: #f8f9fa;
  }

  .course-details-cell {
    padding: 0 !important;
  }

  .course-details-cell .w3-container {
    padding: 16px;
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
  }

  .course-sdg {
    display: inline-block;
    width: 15px;
    height: 15px;
    border-radius: 3px;
    margin-right: 3px;
  }

  /* Course Details */
  .course-details {
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 5px;
    min-height: 300px;
  }

  .course-details p {
    margin: 5px 0;
  }

  .course-details a {
    color: #0066cc;
    text-decoration: none;
  }

  .course-details a:hover {
    text-decoration: underline;
  }

  /* Lists */
  .sdg-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }

  .feature-list {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px;
  }

  .feature-item {
    background-color: #e6f3ff;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    display: inline-block;
    margin: 2px;
  }

  /* SDG Legend */
  .sdg-legend-item {
    display: flex;
    align-items: center;
    margin-right: 10px;
    margin-bottom: 5px;
    font-size: 0.8em;
  }

  .sdg-color {
    width: 15px;
    height: 15px;
    margin-right: 5px;
    border-radius: 3px;
  }

  .sdg-code {
    font-weight: bold;
    margin-right: 5px;
  }

  /* Dropdown */
  .w3-dropdown-content {
    display: none;
    position: relative;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
  }

  .w3-dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
  }

  .w3-dropdown-content a:hover {
    background-color: #f1f1f1;
  }

  .w3-dropdown-clicker:hover .w3-dropdown-content {
    display: block;
  }

  /* Responsive */
  @media screen and (max-width: 600px) {
    .w3-main {
      margin-left: 0;
      padding-left: 20px;
      padding-right: 20px;
    }

    .w3-quarter,
    .w3-col.m3,
    .w3-col.m9,
    .w3-col.m6 {
      width: 100%;
      padding: 0 !important;
    }

    .copyright {
      font-size: 12px;
      line-height: 1.5;
    }

    .copyright span {
      display: inline-block;
      margin: 0 3px;
    }

    .w3-sidebar {
      width: 100%;
    }
  }

  /* Specific Adjustments */
  .w3-quarter img {
    width: 168.75px;
  }

  .w3-quarter h4 {
    font-weight: bold;
    margin-top: 10px;
    margin-bottom: 10px;
    text-align: left;
  }

  .w3-quarter p {
    margin-top: 10px;
  }

  .w3-quarter .w3-container {
    text-align: left;
  }

  .w3-sidebar .w3-col {
    margin-top: 10px;
  }

  .w3-sidebar .w3-bar {
    text-align: left;
    margin-top: 10px;
  }

  .w3-sidebar .w3-bar span {
    display: block;
    margin-top: 5px;
  }

  /* Horizontal Layout Styles */
  .horizontal-container {
    display: flex;
    flex-direction: column;
    align-items: left;
    width: 100%;
  }

  .horizontal-container h1 {
    width: 100%;
    text-align: left;
  }

  .horizontal-container .selector-container {
    width: 100%;
    justify-content: left;
    gap: 40px;
  }

  .horizontal-container .selector-box {
    flex: 1;
    max-width: 300px;
  }

  .horizontal-container .degree-info {
    width: 100%;
    text-align: left;
  }

  .horizontal-container .degree-info p {
    display: inline-block;
    margin: 5px 10px;
  }
</style>

</head>
<body class="w3-light-grey">

<!-- Top container -->
<div class="w3-bar w3-top w3-black w3-large" style="z-index:4">
  <button class="w3-bar-item w3-button w3-hide-large w3-hover-none w3-hover-text-light-grey" onclick="w3_open()">
    <i class="fa fa-bars"></i> Menu
  </button>
  <span class="w3-bar-item w3-right">ODS a la Universitat Rovira i Virgili</span>
</div>

<!-- Sidebar/menu -->
<nav class="w3-sidebar w3-collapse w3-white w3-animate-left" style="z-index:3;width:300px;" id="mySidebar">
  <br>
  <div class="w3-container w3-row">
    <div class="w3-col s4">
      <img src="../assets/logos/edited/cat/cat_ods_logo_cut.png" class="w3-circle" style="width:72px">
    </div>
    <div class="w3-col s8 w3-bar">
      <span>ODS a la Universitat</span>
      <span>Rovira i Virgili</span>
    </div>
  </div>
  <hr>
  <div class="w3-bar-block">
    <a href="../index.html" class="w3-bar-item w3-button w3-padding">
      <i class="fa fa-home fa-fw"></i> Inici
    </a>
    <div class="w3-dropdown-clicker w3-bar-item w3-button w3-padding">
      <i class="fa fa-line-chart fa-fw"></i> Anàlisi
      <div class="w3-dropdown-content">
        <a href="../pages/faculty.html" class="w3-bar-item w3-button w3-padding">
          <i class="fa fa-university fa-fw"></i> Facultats i Escoles (núvol de paraules)
        </a>
        <a href="../pages/faculty2.html" class="w3-bar-item w3-button w3-padding">
          <i class="fa fa-university fa-fw"></i> Facultats i Escoles (gràfics circulars)
        </a>
        <a href="../pages/degree.html" class="w3-bar-item w3-button w3-padding">
          <i class="fa fa-book fa-fw"></i> Ensenyaments
        </a>
        <a href="../pages/course.html" class="w3-bar-item w3-button w3-padding w3-blue">
          <i class="fa fa-pencil fa-fw"></i> Assignatures de l'ensenyament
        </a>
        <a href="../pages/course2.html" class="w3-bar-item w3-button w3-padding">
          <i class="fa fa-pencil fa-fw"></i> Assignatura en detall
        </a>
      </div>
    </div>
    <a href="../pages/info.html" class="w3-bar-item w3-button w3-padding">
      <i class="fa fa-info-circle fa-fw"></i> Informació
    </a>
    <a href="../pages/contact.html" class="w3-bar-item w3-button w3-padding">
      <i class="fa fa-envelope fa-fw"></i> Contacte
    </a>
  </div>
</nav>

<!-- Overlay effect when opening sidebar on small screens -->
<div class="w3-overlay w3-hide-large w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>

<!-- !PAGE CONTENT! -->
<div class="w3-main" style="margin-left:300px;margin-top:43px;">

  <!-- Header -->
  <header class="w3-container" style="padding-top:22px">
    <h5><b><i class="fa fa-pencil"></i> Assignatures</b></h5>
  </header>

  <!-- Main Content -->
  <div class="horizontal-container">
    <h1>Assignatures de la Universitat Rovira i Virgili</h1>
    <p>Aquesta pàgina mostra informació sobre les assignatures de l'ensenyament de la URV concret que vosté seleccioni 
      i mostra la seva alineació amb els Objectius de Desenvolupament Sostenible.</p>

    <!-- Selectors -->
    <div class="selector-container">
      <div class="selector-box">
        <label for="faculty-select">Facultat:</label>
        <select id="faculty-select" class="w3-select w3-border" onchange="updateDegreeSelect()">
          <option value="">-- Selecciona una Facultat/Escola --</option>
        </select>
      </div>
      <div class="selector-box">
        <label for="degree-select">Ensenyament:</label>
        <select id="degree-select" class="w3-select w3-border" onchange="updateCourseSelect()" disabled>
          <option value="">-- Selecciona un ensenyament --</option>
        </select>
      </div>
    </div>

    <!-- Teaching Information -->
    <div id="degree-info-container" class="degree-info" style="display: none;">
      <h3 id="degree-title"></h3>
      <p><strong>Facultat:</strong> <span id="degree-faculty"></span></p>
      <p><strong>Any:</strong> <span id="degree-year"></span></p>
      <p><strong>Total d'assignatures:</strong> <span id="total-courses"></span></p>
    </div>

    <!-- Courses Table -->
    <div id="courses-table-container" style="display: none; margin-top: 20px;">
      <h3>Llista d'assignatures de l'ensenyament</h3>
      <table class="courses-table">
        <thead>
          <tr>
            <th>Assignatura</th>
            <th>ODS identificats</th>
            <th>Crèdits</th>
            <th>Curs</th>
            <th>Quadrimestre</th>
          </tr>
        </thead>
        <tbody id="courses-table-body">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Footer -->
  <footer class="w3-container w3-padding-16 w3-light-grey">
    <div class="footer-content">
      <div class="copyright w3-center">
        © Universitat Rovira i Virgili
        <span>·</span>
        <a href="/ca/universitat/comunicacio/web/legal/">Avís legal</a>
        <span>·</span>
        <a href="/ca/universitat/comunicacio/web/legal/galetes/">Política de galetes</a>
        <span>·</span>
        <a href="/ca/universitat/comunicacio/web/accessibilitat/">Accessibilitat</a>
        <span>·</span>
        <a href="/ca/universitat/comunicacio/web/suport/">Sobre aquest web</a>
      </div>
    </div>
  </footer>

  <!-- End page content -->
</div>

<script>
// Get the Sidebar
var mySidebar = document.getElementById("mySidebar");

// Get the DIV with overlay effect
var overlayBg = document.getElementById("myOverlay");

// Toggle between showing and hiding the sidebar, and add overlay effect
function w3_open() {
  if (mySidebar.style.display === 'block') {
    mySidebar.style.display = 'none';
    overlayBg.style.display = "none";
  } else {
    mySidebar.style.display = 'block';
    overlayBg.style.display = "block";
  }
}

// Close the sidebar with the close button
function w3_close() {
  mySidebar.style.display = "none";
  overlayBg.style.display = "none";
}

// SDG Definitions
const sdgDefinitions = {
  "ODS-01": "Fi de la pobresa",
  "ODS-02": "Fam zero",
  "ODS-03": "Salut i benestar",
  "ODS-04": "Educació de qualitat",
  "ODS-05": "Igualtat de gènere",
  "ODS-06": "Aigua neta i sanejament",
  "ODS-07": "Energia neta i assequible",
  "ODS-08": "Treball digne i creixement econòmic",
  "ODS-09": "Indústria, innovació i infraestructura",
  "ODS-10": "Reducció de les desigualtats",
  "ODS-11": "Ciutats i comunitats sostenibles",
  "ODS-12": "Producció i consum responsables",
  "ODS-13": "Acció climàtica",
  "ODS-14": "Vida submarina",
  "ODS-15": "Vida d'ecosistemes terrestres",
  "ODS-16": "Pau, justícia i institucions sòlides",
  "ODS-17": "Aliança per assolir els objectius"
};

// SDG Colors
const sdgColors = {
  "ODS-01": "#e5243b",
  "ODS-02": "#dda63a",
  "ODS-03": "#4c9f38",
  "ODS-04": "#c5192d",
  "ODS-05": "#ff3a21",
  "ODS-06": "#26bde2",
  "ODS-07": "#fcc30b",
  "ODS-08": "#a21942",
  "ODS-09": "#fd6925",
  "ODS-10": "#dd1367",
  "ODS-11": "#fd9d24",
  "ODS-12": "#bf8b2e",
  "ODS-13": "#3f7e44",
  "ODS-14": "#0a97d9",
  "ODS-15": "#56c02b",
  "ODS-16": "#00689d",
  "ODS-17": "#19486a"
};

// Course Year Order
const courseYearOrder = {
  "Primer curs": 1,
  "Segon curs": 2,
  "Tercer curs": 3,
  "Quart curs": 4,
  "Cinquè curs": 5,
  "Sisè curs": 6,
  "Optatives": 7
};

// Function to transform SDG nomenclature to ODS
function transformSDGToODS(sdgArray) {
  if (!sdgArray || !sdgArray[0]) return [];
  return sdgArray[0].map(sdg => sdg.replace('SDG-', 'ODS-'));
}

// Global variable to store data
let facultiesData = [];

// Function to capitalize the first letter of a string
function capitalizeFirstLetter(str) {
  if (!str) return str;
  return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}

// Function to load data from JSON
async function loadData() {
  try {
    const response = await fetch('../data/urv-sdgs.json');
    if (!response.ok) {
      throw new Error('Error al cargar los datos');
    }
    facultiesData = await response.json();
    initSelectors();
  } catch (error) {
    console.error('Error:', error);
    // Show error message to the user
    const container = document.querySelector('.horizontal-container');
    container.innerHTML = `
      <div class="w3-panel w3-red w3-round">
        <h3>Error</h3>
        <p>No se han podido cargar los datos. Por favor, inténtelo más tarde.</p>
        <p>Detalle: ${error.message}</p>
      </div>
    `;
  }
}

// Function to initialize selectors
function initSelectors() {
  // Populate the faculty selector
  const facultySelect = document.getElementById('faculty-select');

  // Sort faculties alphabetically
  facultiesData.sort((a, b) => a.faculty_school_name.localeCompare(b.faculty_school_name));

  facultiesData.forEach(faculty => {
    const option = document.createElement('option');
    option.value = faculty.faculty_school_name;
    option.textContent = faculty.faculty_school_name;
    facultySelect.appendChild(option);
  });
}

// Function to update the degree selector based on the selected faculty
function updateDegreeSelect() {
  const facultySelect = document.getElementById('faculty-select');
  const degreeSelect = document.getElementById('degree-select');
  const selectedFaculty = facultySelect.value;

  degreeSelect.innerHTML = '<option value="">-- Selecciona un ensenyament --</option>';
  degreeSelect.disabled = !selectedFaculty;

  if (selectedFaculty) {
    const selectedFacultyData = facultiesData.find(faculty => faculty.faculty_school_name === selectedFaculty);

    // Sort degrees alphabetically
    selectedFacultyData.degrees.sort((a, b) => a.degree_name.localeCompare(b.degree_name));

    selectedFacultyData.degrees.forEach(degree => {
      const option = document.createElement('option');
      option.value = degree.degree_name;
      option.textContent = degree.degree_name;
      degreeSelect.appendChild(option);
    });
  }

  // Clear information
  resetUI();
}

// Function to update the course selector based on the selected degree
function updateCourseSelect() {
  const facultySelect = document.getElementById('faculty-select');
  const degreeSelect = document.getElementById('degree-select');
  const selectedFaculty = facultySelect.value;
  const selectedDegree = degreeSelect.value;

  if (selectedFaculty && selectedDegree) {
    const facultyData = facultiesData.find(f => f.faculty_school_name === selectedFaculty);
    const degreeData = facultyData.degrees.find(d => d.degree_name === selectedDegree);

    if (degreeData && degreeData.courses) {
      // Show degree information
      document.getElementById('degree-info-container').style.display = 'block';
      document.getElementById('degree-title').textContent = selectedDegree;
      document.getElementById('degree-faculty').textContent = selectedFaculty;
      document.getElementById('degree-year').textContent = degreeData.degree_year || 'No disponible';
      document.getElementById('total-courses').textContent = degreeData.courses.length;

      // Add new fields
      const degreeInfoContainer = document.getElementById('degree-info-container');

      // Check if elements already exist to avoid duplication
      if (!document.getElementById('sdg-courses')) {
        const sdgCoursesP = document.createElement('p');
        sdgCoursesP.innerHTML = '<strong>Assignatures amb ODS:</strong> <span id="sdg-courses"></span>';
        degreeInfoContainer.appendChild(sdgCoursesP);
      }

      if (!document.getElementById('sdg-ratio')) {
        const sdgRatioP = document.createElement('p');
        sdgRatioP.innerHTML = '<strong>Ratio d\'assignatures amb ODS per ensenyament:</strong> <span id="sdg-ratio"></span>';
        degreeInfoContainer.appendChild(sdgRatioP);
      }

      // Update values
      document.getElementById('sdg-courses').textContent = degreeData.sdg_courses_degree || 'No disponible';
      document.getElementById('sdg-ratio').textContent = degreeData.sdg_ratio_degree ?
        `${degreeData.sdg_ratio_degree}%` : 'No disponible';

      // Show courses table
      showCoursesTable(degreeData.courses);
    }
  }
}

// Function to show the courses table
function showCoursesTable(courses) {
  const tableContainer = document.getElementById('courses-table-container');
  const tableBody = document.getElementById('courses-table-body');

  tableBody.innerHTML = '';

  // Sort first by course year according to the specified order and then alphabetically
  courses.sort((a, b) => {
    const aOrder = courseYearOrder[a.year] || 8; // 8 for unspecified values
    const bOrder = courseYearOrder[b.year] || 8;

    if (aOrder !== bOrder) {
      return aOrder - bOrder;
    }
    return a.course_name.localeCompare(b.course_name);
  });

  courses.forEach(course => {
    // Main row
    const row = document.createElement('tr');
    row.className = 'course-row';
    row.setAttribute('data-course', JSON.stringify(course));
    row.onclick = function() { toggleCourseDetails(this); };

    const nameCell = document.createElement('td');
    const sdgsCell = document.createElement('td');
    const creditsCell = document.createElement('td');
    const yearCell = document.createElement('td');
    const periodCell = document.createElement('td');

    // Show subject name with the first letter capitalized
    nameCell.textContent = capitalizeFirstLetter(course.course_name);
    creditsCell.textContent = course.credits || 'No disponible';
    yearCell.textContent = course.year || 'No disponible';
    periodCell.textContent = course.course_period || 'No disponible';

    // Show the SDGs of the subject with their colors
    if (course.sdg && course.sdg.length > 0 && course.sdg[0].length > 0) {
      const odsList = transformSDGToODS(course.sdg);
      odsList.forEach(ods => {
        const sdgSpan = document.createElement('span');
        sdgSpan.className = 'course-sdg';
        sdgSpan.title = `${ods}: ${sdgDefinitions[ods]}`;
        sdgSpan.style.backgroundColor = sdgColors[ods];
        sdgsCell.appendChild(sdgSpan);
      });
    } else {
      sdgsCell.textContent = 'No té ODS associats';
    }

    row.appendChild(nameCell);
    row.appendChild(sdgsCell);
    row.appendChild(creditsCell);
    row.appendChild(yearCell);
    row.appendChild(periodCell);
    tableBody.appendChild(row);

    // Details row (initially hidden)
    const detailsRow = document.createElement('tr');
    detailsRow.className = 'course-details-row';
    detailsRow.style.display = 'none';

    const detailsCell = document.createElement('td');
    detailsCell.colSpan = 5;
    detailsCell.className = 'course-details-cell';
    detailsRow.appendChild(detailsCell);
    tableBody.appendChild(detailsRow);
  });

  tableContainer.style.display = 'block';
}

// Function to show/hide details when clicking on a row
function toggleCourseDetails(row) {
  const detailsRow = row.nextElementSibling;
  const detailsCell = detailsRow.querySelector('.course-details-cell');

  if (detailsRow.style.display === 'none') {
    const courseData = JSON.parse(row.getAttribute('data-course'));

    // Generate details content
    detailsCell.innerHTML = `
      <div class="w3-container w3-padding">
        <h4>${capitalizeFirstLetter(courseData.course_name)}</h4>
        <div class="w3-row">
          <div class="w3-col m6">
            <p><strong>Codi:</strong> ${courseData.course_code || 'No disponible'}</p>
            <p><strong>Crèdits:</strong> ${courseData.credits || 'No disponible'}</p>
            <p><strong>Modalitat:</strong> ${courseData.course_delivery_mode || 'No disponible'}</p>
          </div>
          <div class="w3-col m6">
            <p><strong>Quadrimestre:</strong> ${courseData.course_period || 'No disponible'}</p>
            <p><strong>Tipus:</strong> ${courseData.course_type || 'No disponible'}</p>
            <p><strong>Curs:</strong> ${courseData.year || 'No disponible'}</p>
          </div>
        </div>
        ${courseData.course_url ?
          `<p><strong>Guia docent:</strong> <a href="${courseData.course_url}" target="_blank">Veure guia docent</a></p>` : ''}

        <div class="w3-margin-top">
          <strong>ODS identificats:</strong>
          <div class="sdg-list">
          ${courseData.sdg && courseData.sdg[0] && courseData.sdg[0].length > 0 ?
            transformSDGToODS(courseData.sdg).map(ods => `
              <div class="sdg-legend-item">
                <div class="sdg-color" style="background-color: ${sdgColors[ods]};"></div>
                <span class="sdg-code">${ods}</span>
                <span class="sdg-name">${sdgDefinitions[ods]}</span>
              </div>
            `).join('') : 'No té ODS associats'}
          </div>
        </div>

        ${courseData.features && courseData.features[0] && courseData.features[0].length > 0 ? `
        <div class="w3-margin-top">
          <strong>Paraules clau (en anglès):</strong>
          <div class="feature-list">
            ${courseData.features[0].map(feature => `
              <div class="feature-item">${feature}</div>
            `).join('')}
          </div>
        </div>
        ` : ''}
      </div>
    `;

    detailsRow.style.display = 'table-row';
  } else {
    detailsRow.style.display = 'none';
  }
}

// Function to reset the UI
function resetUI() {
  document.getElementById('degree-info-container').style.display = 'none';
  document.getElementById('courses-table-container').style.display = 'none';

  // Clear new fields if they exist
  if (document.getElementById('sdg-courses')) {
    document.getElementById('sdg-courses').textContent = '';
  }
  if (document.getElementById('sdg-ratio')) {
    document.getElementById('sdg-ratio').textContent = '';
  }
}

// Load data and create selectors
document.addEventListener('DOMContentLoaded', function() {
  // Load data from JSON
  loadData();
});
</script>

</body>
</html>
